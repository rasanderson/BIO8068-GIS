---
title: "Interactive visualisation of environmental data in decision support systems"
subtitle: "BIO8068 Data visualisation in Ecology"
output:
  word_document:
    reference_docx: word_template.docx
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options("rgdal_show_exportToProj4_warnings"="none")
library(sf)
library(raster)
library(mapview)
```

# Introduction
You can use R to undertake many, but not all, of the most common GIS spatial analyses that you may encounter. This allows you to integrate your R code into shiny web-hosted applications, so that as well as simply displaying spatial data, you can start to develop something analogous to a **decision support system** or DSS. Originally DSS had to be hosted on dedicated computer clusters, and required their own unique interface. Now however they can be hosted on web-servers, making them more accessible. Key design decisions remain:

* Who is the end-user? Typically for a DSS the end-user is some sort of policy-maker, or decision-maker. Think back to your windfarm assignment in BIO8069.
* Who makes the final decision? The final decision as to where to place a windfarm will be made by elected councillors, advised by council planning officials, in consultation with environmental agencies.
* Who has access to the DSS? Council officials will receive reports and advice from private environmental consultancy companies, possibly hired by the windfarm developers. Representations will also be made by conservation bodies, local residents' associations etc. Will they have access to the DSS?
* What data is in the DSS? Typically DSS contain a mixture of geographical, environmental, economic and social data. However, as these are drawn from different data sources they can be challenging to keep updated, or at the appropriate spatial scale.
* What will the DSS be able to model and predict? I have been involved in DSS where economists, ecologists and hydrologists all had to collaborate to construct the underlying models. Each discipline had its own assumptions, and unexpected incompatibilities, especially with regard to spatial and temporal scale, were constant challenges. All models are simplifications of reality. The DSS should be sufficiently constrained so as not to make predictions outside of its realistic limits of operation.
* How will DSS outputs be visualised? This is of critical importance. Graphical displays are easier to understand, but also easier to mis-interpret.

In this practical we will focus on some of the key geospatial tools you will find useful for building a DSS. Note that when you come to doing your assignment, you are definitely **not** expected to incorporate all these GIS tools into your simple DSS. Rather, it is to give you an understanding of some of the commonly used GIS analyses, such as those found in ArcGIS Toolbox, within R. In particular:

* raster vs vector conversion
* buffering
* clipping
* GIS raster overlay (equivalent to Raster Calculator)

Most of these steps are described very clearly in <https://geocompr.robinlovelace.net/index.html>  Ironically, one key facility, common to all GIS (ArcGIS, QGIS, GRASS GIS) is not available in R, and that is Viewshed Analysis. I have therefore written a function for you to undertake this task, should you wish to implement it. To make it easier for you to understand the connections between GIS and creating a simple DSS, we'll use the "Working with Elevation Data" practical from BIO8069 as a template. This has the advantage that you will be familiar with all the datasets, and it is simply understanding the implementation in R that matters. I have exported the relevant files for you in a format accessible by R. The following uses the same section and sub-section numbering and titles as in the BIO8069 practical, to make it easy for you to compare analyses.

# 1. Display of elevation data
You will display the following information

* **pan50m** - 50m resolution map of elevation in North Pennine hills
* **se82, se02** - Ordnance Survey backdrop rasters. We don't need these but will use leaflet instead.
* **settlements** - vector (polygon) map of urban areas
* **wind_turbines** - the viewshed function I have created is more limited than the one in ArcGIS, so we will adapt this map accordingly.

## 1.1 Display of elevation data - contours and shading
The original backdrop map was Ordnance Survey. For simplicity and speed in R, we can use the `mapview` package to visualise the data in RStudio, and it is easy to adapt these for `leaflet` if you want finer-grained control. Remember that `mapview` assumes your data will be in **latitude-longitude** format, EPSG 4326, whereas when working with your data to calculate distances etc. you will work with Ordnance Survey EPSG 27700. This is a bit irritating, as you will have to convert to latitude longitude for a **dynamic** display. If you are happy with a **static** display then Ordnance Survey is fine.

Begin by loading creating a new RStudio project for this practical. Within the project folder, create a subfolder to store the GIS data that you are going to import into R. I am calling mine `gis_data`. The data are on Canvas as a zip file for download.

Load the relevant libraries as shown below. The rather weird `options` line is to suppress warnings about `ellipsoid discarded` or `showSRID`. These warnings have started to be displayed in the last 12 months due to upgrades to the geospatial system in R, which makes it more accurate, but not all packages are synchronised. However, it does not affect the functioning.

```{r, eval=FALSE}
options("rgdal_show_exportToProj4_warnings"="none")
library(sf)
library(raster)
library(mapview)
```

If you receive errors that either library is not available, remember to install them with `install.packages()`. Now import and display the 50m resolution raster elevation map. This is available as a TIF format file (geotiff). Assuming your TIF format files are in `gis_data` now load them into R:

```{r}
# Import raster elevation data Ordnance Survey projection
pan50m <- raster("gis_data/pan50m.tif")
plot(pan50m)

# You will notice that the default colours are the wrong way round, so we can
# use the terrain.colors option to set low elevation to green, high to brown, 
# with 30 colour categories
plot(pan50m, col=terrain.colors(30))
```

This provides a static map, using the OS projection system (note the coordinates on the horizontal and vertical axes) of the elevation in the North Pennines between Burnley and Bradford. To create a dynamic map that you can overlay onto several different baselayers, remember to convert to latitude-longitude first.

```{r}
ll_crs <- CRS("+init=epsg:4326")  # 4326 is the code for latitude longitude
pan50m_ll <- projectRaster(pan50m, crs=ll_crs)
mapview(pan50m_ll)
```

As maps created with `mapview` you can zoom and pan your map, display or hide the elevation data, show a backdrop with satellite, Open StreetMap etc. If you want to be really fancy, it is relatively straightforward to create a hillshade map from elevation data, which can also provide an attractive visualisation that highlights the structure of the elevation as if caught by sunlight.:

```{r}
hs = hillShade(slope = terrain(pan50m, "slope"), aspect = terrain(pan50m, "aspect"))
plot(hs, col = gray(0:100 / 100), legend = FALSE)
# overlay with DEM
plot(pan50m, col = terrain.colors(25), alpha = 0.5, add = TRUE)
```

## 1.2 Creation of contours from raster DTM
It is easy to create a contour map from your dem using `rasterToContour`. I've pushed the output through `st_as_sf()` to convert it from `sp` format to `sf` vector format, as the latter is becoming more widely used in R.

```{r}
pan_contours <- rasterToContour(pan50m) %>% st_as_sf()
plot(pan50m)
plot(pan_contours, add=TRUE)
```

# 2. Add DTM-derived information to site data
## 2.1 Wind turbines dataset
We have two wind farms, with turbines at slightly different heights. In ArcGIS the height of the turbine is recorded in OFFSETA, and the height of the human observer in OFFSETB. The turbine data are in the `wind_turbine.shp` shapefiles, which again I am assuming are in your `gis_data` subfolder within your RStudio project. **Note** Although we usually refer to "a shapefile" it is actually a collection of files, with slightly different extensions (.prj, .sbx, .dbf, .shp). When you read the shapefile into RStudio, you only need to give the .shp filename, and it will automatically detect the others.

```{r}
wind_turbines <- st_read("gis_data/wind_turbines.shp")
print(wind_turbines)
plot(pan50m)
plot(wind_turbines)
```

As you have imported the data using `st_read` the `wind_turbines` object is of class `sf`, which gives a convenient display if printed in the R Console, showing both the coordinate reference system (Ordnance Survey GB) and the first 10 records, including OFFSETA and OFFSETB. If you wish, use `st_transform(wind_turbines, 4326)` to create a latitude-longitude version of your windfarm data, and view it interactively in `mapview`.

## 2.3 Calculate slope and 2.4 Calculate aspect
To create a slope and aspect raster maps the `terrain` function can be used. This is quite straightforward to implement in R. By default it calculates both slope and aspect in radians, so for consistency with ArcGIS I've added `unit="degrees"`. The interpretation of the aspect values is identical to ArcGIS, i.e. values near 350, 360, 0, 5 degrees are north-facing, around 90 degrees east-facing etc.

```{r, eval=FALSE}
dem_slope  <- terrain(pan50m, unit="degrees") # defaults to slope
dem_aspect <- terrain(pan50m, opt="aspect", unit="degrees")
plot(dem_slope)
plot(dem_aspect)
```

After enduring the sluggishness of ArcGIS, you might be pleasantly surprised by how quickly some of these commands run!

## 2.4 Add slope and aspect values to wind turbines attributes
Strictly-speaking this isn't essential to calculate viewsheds, but I've included it here as it is straightforward in R should you require this type of facility. Basically, you're going to transfer some of the information from the `dem_slope` and `dem_aspect` maps you've just created into two new columns in your `wind_turbines` map, using the `extract` function. This simply creates a list of the extracted values at each wind turbine, and we can assign this to a new column using the `wind_turbines$slope <-` or `wind_turbines$aspect <-`

```{r, eval=FALSE}
wind_turbines$slope <- extract(dem_slope, wind_turbines)
wind_turbines$aspect <- extract(dem_slope, wind_turbines)
```

Print the first 10 rows of `wind_turbines` in the RStudio Console window, and you will see the two additional columns. If you want to see e.g. 20 rows, simply issue `print(wind_turbines, n=20)` in the Console.

# 3. Create a viewshed
Unfortunately none of the spatial packages in R have a viewshed function, therefore I have created one for you, in the file `LOS.R`. Download this file from Canvas and save it in your RStudio project folder. When you add the command

```{r}
source("LOS.R")
```

to your script several additional functions will be created, the key one being `viewshed()`. This takes the following arguments:

* `dem = ` The name of the digital elevation map, assumed to be `raster` format.
* `windfarm = ` The name of the windfarm location, assumed to be `sf` point format. Currently the `viewshed` function only accepts a single point as it would be too slow to run across multiple points. Therefore you will need to pick a single wind-turbine in the centre of each of your two windfarms in this example, and run `viewshed` twice.
* `h1 = ` The height of the human observer, i.e. OFFSETA. Defaults to 1.75m if not given.
* `h2 = ` The height of the wind turbine, i.e. OFFSETB. Defaults to 75m if not given.
* `radius = ` Maximum radius for the viewshed, i.e. RADIUS2. Defaults to NULL if not given.
* `vector = ` Whether to return results as a points vector output. Defaults to `raster` if not given.

You might be wondering why OFFSETA and OFFSETB are not automatically collected from the `wind_turbines` map. This is partly as coding it would be more complex, but also to give you maximum flexibility when creating a Decision Support System. For example, you might want the end-user to be able to vary the potential height of a turbine (within a range) to determine the effects on the viewshed.

The next steps guide you through creating separate viewsheds for the west (Lancashire) and east (Yorkshire) windfarms, and then merging together. As we will only pick a central point for one of the turbines at each windfarm, the viewshed will not be quite as accurate as that calculated in ArcGIS.

## 3.2

