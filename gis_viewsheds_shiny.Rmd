---
title: "Interactive visualisation of environmental data in decision support systems"
subtitle: "BIO8068 Data visualisation in Ecology"
output:
  word_document:
    reference_docx: word_template.docx
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options("rgdal_show_exportToProj4_warnings"="none")
library(sf)
library(raster)
library(mapview)
```

# Introduction
You can use R to undertake many, but not all, of the most common GIS spatial analyses that you may encounter. This allows you to integrate your R code into shiny web-hosted applications, so that as well as simply displaying spatial data, you can start to develop something analogous to a **decision support system** or DSS. Originally DSS had to be hosted on dedicated computer clusters, and required their own unique interface. Now however they can be hosted on web-servers, making them more accessible. Key design decisions remain:

* Who is the end-user? Typically for a DSS the end-user is some sort of policy-maker, or decision-maker. Think back to your windfarm assignment in BIO8069.
* Who makes the final decision? The final decision as to where to place a windfarm will be made by elected councillors, advised by council planning officials, in consultation with environmental agencies.
* Who has access to the DSS? Council officials will receive reports and advice from private environmental consultancy companies, possibly hired by the windfarm developers. Representations will also be made by conservation bodies, local residents' associations etc. Will they have access to the DSS?
* What data is in the DSS? Typically DSS contain a mixture of geographical, environmental, economic and social data. However, as these are drawn from different data sources they can be challenging to keep updated, or at the appropriate spatial scale.
* What will the DSS be able to model and predict? I have been involved in DSS where economists, ecologists and hydrologists all had to collaborate to construct the underlying models. Each discipline had its own assumptions, and unexpected incompatibilities, especially with regard to spatial and temporal scale, were constant challenges. All models are simplifications of reality. The DSS should be sufficiently constrained so as not to make predictions outside of its realistic limits of operation.
* How will DSS outputs be visualised? This is of critical importance. Graphical displays are easier to understand, but also easier to mis-interpret.

In this practical we will focus on some of the key geospatial tools you will find useful for building a DSS. Note that when you come to doing your assignment, you are definitely **not** expected to incorporate all these GIS tools into your simple DSS. Rather, it is to give you an understanding of some of the commonly used GIS analyses, such as those found in ArcGIS Toolbox, within R. In particular:

* raster vs vector conversion
* buffering
* clipping
* GIS raster overlay (equivalent to Raster Calculator)

Most of these steps are described very clearly in <https://geocompr.robinlovelace.net/index.html>  Ironically, one key facility, common to all GIS (ArcGIS, QGIS, GRASS GIS) is not available in R, and that is Viewshed Analysis. I have therefore written a function for you to undertake this task, should you wish to implement it. To make it easier for you to understand the connections between GIS and creating a simple DSS, we'll use the "Working with Elevation Data" practical from BIO8069 as a template. This has the advantage that you will be familiar with all the datasets, and it is simply understanding the implementation in R that matters. I have exported the relevant files for you in a format accessible by R. The following uses the same section and sub-section numbering and titles as in the BIO8069 practical, to make it easy for you to compare analyses.

# 1. Display of elevation data
You will display the following information

* **pan50m** - 50m resolution map of elevation in North Pennine hills
* **se82, se02** - Ordnance Survey backdrop rasters. We don't need these but will use leaflet instead.
* **settlements** - vector (polygon) map of urban areas
* **wind_turbines** - the viewshed function I have created is more limited than the one in ArcGIS, so we will adapt this map accordingly.

## 1.1 Display of elevation data - contours and shading
The original backdrop map was Ordnance Survey. For simplicity and speed in R, we can use the `mapview` package to visualise the data in RStudio, and it is easy to adapt these for `leaflet` if you want finer-grained control. Remember that `mapview` assumes your data will be in **latitude-longitude** format, EPSG 4326, whereas when working with your data to calculate distances etc. you will work with Ordnance Survey EPSG 27700. This is a bit irritating, as you will have to convert to latitude longitude for a **dynamic** display. If you are happy with a **static** display then Ordnance Survey is fine.

Begin by loading creating a new RStudio project for this practical. Within the project folder, create a subfolder to store the GIS data that you are going to import into R. I am calling mine `gis_data`. The data are on Canvas as a zip file for download.

Load the relevant libraries as shown below. The rather weird `options` line is to suppress warnings about `ellipsoid discarded` or `showSRID`. These warnings have started to be displayed in the last 12 months due to upgrades to the geospatial system in R, which makes it more accurate, but not all packages are synchronised. However, it does not affect the functioning.

```{r, eval=FALSE}
options("rgdal_show_exportToProj4_warnings"="none")
library(sf)
library(raster)
library(mapview)
```

If you receive errors that either library is not available, remember to install them with `install.packages()`. Now import and display the 50m resolution raster elevation map. This is available as a TIF format file (geotiff). Assuming your TIF format files are in `gis_data` now load them into R:

```{r}
# Import raster elevation data Ordnance Survey projection
pan50m <- raster("gis_data/pan50m.tif")
plot(pan50m)

# You will notice that the default colours are the wrong way round, so we can
# use the terrain.colors option to set low elevation to green, high to brown, 
# with 30 colour categories
plot(pan50m, col=terrain.colors(30))
```

This provides a static map, using the OS projection system (note the coordinates on the horizontal and vertical axes) of the elevation in the North Pennines between Burnley and Bradford. To create a dynamic map that you can overlay onto several different baselayers, remember to convert to latitude-longitude first.

```{r}
ll_crs <- CRS("+init=epsg:4326")  # 4326 is the code for latitude longitude
pan50m_ll <- projectRaster(pan50m, crs=ll_crs)
mapview(pan50m_ll)
```

As maps created with `mapview` you can zoom and pan your map, display or hide the elevation data, show a backdrop with satellite, Open StreetMap etc. Finally, let's see how easy it is to create a contour map from your dem using `rasterToContour`. I've pushed the output through `st_as_sf()` to convert it from `sp` format to `sf` vector format, as the latter is becoming more widely used in R.

```{r}
pan_contours <- rasterToContour(pan50m) %>% st_as_sf()
plot(pan50m)
plot(pan_contours, add=TRUE)
```

If you want to be really fancy, it is relatively straightforward to create a hillshade map from elevation data, which can also provide an attractive visualisation that highlights the structure of the elevation as if caught by sunlight.:

```{r}
hs = hillShade(slope = terrain(pan50m, "slope"), aspect = terrain(pan50m, "aspect"))
plot(hs, col = gray(0:100 / 100), legend = FALSE)
# overlay with DEM
plot(pan50m, col = terrain.colors(25), alpha = 0.5, add = TRUE)
```

